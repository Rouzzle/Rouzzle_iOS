//
//  NewTaskSheetView.swift
//  Rouzzle_iOS
//
//  Created by ÍπÄÏ†ïÏõê on 1/19/25.
//

import SwiftUI
struct NewTaskModel {
    var emoji: String?
    var text: String = ""
    var hour: Int = 0
    var min: Int = 0
    var second: Int = 0
    var errorMessage: String?
    var sheetType: SheetType = .task
}

enum SheetType: Hashable {
    case task
    case time
}

struct NewTaskSheet: View {
    
    @Binding var detents: Set<PresentationDetent>
    let action: (RecommendTodoTask) -> Void
    
    @State private var vm: NewTaskModel = .init()
    @Environment(\.dismiss) private var dismiss
    @FocusState var focusField: SheetType?
    
    var formattedTime: String {
        var components: [String] = []
        
        if vm.hour > 0 {
            components.append("\(vm.hour)ÏãúÍ∞Ñ")
        }
        if vm.min > 0 {
            components.append("\(vm.min)Î∂Ñ")
        }
        if vm.second > 0 {
            components.append("\(vm.second)Ï¥à")
        }
        return components.joined(separator: " ")
    }
    
    var body: some View {
        VStack {
            switch vm.sheetType {
            case .task:
                TaskInputView(text: $vm.text, emoji: $vm.emoji, focusField: _focusField) {
                    if vm.text.isEmpty || vm.emoji?.isEmpty == nil {
                        withAnimation {
                            detents = [.fraction(0.15)]
                            vm.errorMessage = "Ïù¥Î™®ÏßÄÏôÄ Ìï† Ïùº Î™®Îëê ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî."
                        }
                        return
                    }
                    let timer = vm.hour * 3600 + vm.min * 60 + vm.second
                    let task = RecommendTodoTask(emoji: vm.emoji ?? "üß©", title: vm.text, timer: timer)
                    action(task)
                    dismiss()
                }
                
                TimeSelectionView(
                    detents: $detents,
                    sheetType: $vm.sheetType,
                    hour: $vm.hour,
                    min: $vm.min,
                    second: $vm.second,
                    errorMessage: $vm.errorMessage,
                    focusField: _focusField
                )
                if vm.errorMessage != nil {
                    Text(vm.errorMessage ?? "")
                        .foregroundStyle(.red)
                }
                
            case .time:
                CustomTimePickerView(
                    hour: vm.hour,
                    min: vm.min,
                    second: vm.second
                ) {
                    withAnimation {
                        focusField = .task
                        detents = [.fraction(0.12)]
                    }
                    vm.sheetType = .task
                } comfirm: { hour, min, second in
                    withAnimation {
                        focusField = .task
                        detents = [.fraction(0.12)]
                    }
                    vm.hour = hour
                    vm.min = min
                    vm.second = second
                    vm.sheetType = .task
                }
                
            }
        }
        .animation(.smooth, value: vm.sheetType)
        .onAppear {
            focusField = .task
        }
        .padding()
    }
}

struct TaskInputView: View {
    @Binding var text: String
    @Binding var emoji: String?
    @FocusState var focusField: SheetType?
    var onAddTask: () -> Void
    var body: some View {
        HStack {
//            EmojiButton(selectedEmoji: $emoji, emojiButtonType: .keyboard) { emoji in
//                self.emoji = emoji
//                focusField = .task
//            }
            
            TextField("Ï∂îÍ∞ÄÌï† Ìï† ÏùºÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.", text: $text)
                .focused($focusField, equals: .task)
                .font(.ptRegular())
            
            Button(action: onAddTask) {
                Image(systemName: "arrow.up")
                    .bold()
                    .padding(8)
                    .foregroundColor(.white)
                    .background(Color.accentColor)
                    .clipShape(Circle())
            }
        }
        .padding(.vertical, 8)
    }
}

struct TimeSelectionView: View {
    @Binding var detents: Set<PresentationDetent>
    @Binding var sheetType: SheetType
    @Binding var hour: Int
    @Binding var min: Int
    @Binding var second: Int
    @Binding var errorMessage: String?
    @FocusState var focusField: SheetType?
    
    var formattedTime: String {
        var components: [String] = []
        
        if hour > 0 {
            components.append("\(hour)ÏãúÍ∞Ñ")
        }
        if min > 0 {
            components.append("\(min)Î∂Ñ")
        }
        if second > 0 {
            components.append("\(second)Ï¥à")
        }
        
        return components.joined(separator: " ")
    }
    
    var body: some View {
        HStack {
            if hour == 0 && min == 0 && second == 0 {
                Button {
                    withAnimation {
                        focusField = nil
                        detents = [.fraction(0.3)]
                        sheetType = .time
                    }
                } label: {
                    HStack {
                        Image(systemName: "gauge.with.needle")
                            .tint(.gray)
                        Text("ÏßÄÏÜç ÏãúÍ∞Ñ ÏóÜÏùå")
                            .foregroundColor(.gray)
                    }
                }
            } else {
                HStack {
                    Image(systemName: "gauge.with.needle")
                        .foregroundColor(.accentColor)
                    HStack {
                        Button {
                            withAnimation {
                                focusField = nil
                                detents = [.fraction(0.3)]
                                sheetType = .time
                            }
                        } label: {
                            Text(" \(formattedTime)")
                        }
                        
                        Button {
                            withAnimation {
                                self.hour = 0
                                self.min = 0
                                self.second = 0
                            }
                        } label: {
                            Image(systemName: "xmark")
                        }
                    }
                    .padding(8)
                    .clipShape(RoundedRectangle(cornerRadius: 12))
                    .overlay {
                        RoundedRectangle(cornerRadius: 12)
                            .stroke(.gray, lineWidth: 1)
                    }
                }
            }
            Spacer()
        }
        .padding(.bottom, 16)
    }
}

struct CustomTimePickerView: View {
    
    @State private var hour: Int = 0
    @State private var min: Int = 0
    @State private var second: Int = 0
    let cancel: () -> Void
    let comfirm: (Int, Int, Int) -> Void
    
    init(
        hour: Int = 0,
        min: Int = 0,
        second: Int = 0,
        cancel: @escaping () -> Void = {},
        comfirm: @escaping (Int, Int, Int) -> Void = {_, _, _ in}
    ) {
        self.hour = hour
        self.min = min
        self.second = second
        self.cancel = cancel
        self.comfirm = comfirm
    }
    
    var body: some View {
        VStack {
            HStack {
                Button {
                    cancel()
                } label: {
                    Text("Ï∑®ÏÜå")
                        .foregroundStyle(.basic)
                }
                
                Spacer()
                
                Button {
                    comfirm(hour, min, second)
                } label: {
                    Text("ÏôÑÎ£å")
                        .foregroundStyle(.basic)
                }
            }
            
            HStack {
                Picker("", selection: $hour) {
                    ForEach(0...5, id: \.self) {
                        Text("\($0) ÏãúÍ∞Ñ").tag($0)
                    }
                }
                .pickerStyle(.wheel)
                
                Picker("", selection: $min) {
                    ForEach(0...59, id: \.self) {
                        Text("\($0) Î∂Ñ").tag($0)
                    }
                }
                .pickerStyle(.wheel)
                
                Picker("", selection: $second) {
                    ForEach(0...59, id: \.self) {
                        Text("\($0) Ï¥à").tag($0)
                    }
                }
                .pickerStyle(.wheel)
                
            }
            .padding(.horizontal)
        }
        .padding()
    }
}

#Preview {
    NewTaskSheet(detents: .constant([.fraction(0.12)]), action: { _ in
        
    })
}
